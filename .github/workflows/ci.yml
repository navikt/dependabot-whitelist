name: CI

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
jobs:

  unit-test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
      - run: npm ci
      - run: npm test

  integration-test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
      - uses: ./
        with:
          milliseconds: 1000

  # The dist/ directory is generated by ncc
  # It has compiled the node modules into a single file, together wit all its dependencies.
  # This job will compile with ncc and compare it to the actual tracked files.
  valid-dist:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
      - uses: actions/setup-node@v2.4.1
        with:
          node-version: 12.x
      - run: npm ci
      - id: diff
        run: |
          if [ "$(git diff --ignore-space-at-eol dist/ | wc -l)" -gt "0" ]; then
            echo "Detected uncommitted changes after build.  See status below:"
            git diff
            exit 1
          fi
